<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jornadas de Competici√≥n ATM</title>
    
    <link rel="icon" type="image/png" href="ESCUDO ATM.png">
    <link rel="shortcut icon" type="image/png" href="ESCUDO ATM.png">

    <link rel="apple-touch-icon" href="Jornadas ATM.png">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#CB3524">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div class="ios-header-container">
        <div class="header-top-row">
            <div class="brand-box">
                <img src="ESCUDO ATM.png" alt="Escudo" class="escudo-header">
                <div class="brand-text">
                    <h1 class="app-title">
                        <span class="t-main">Jornadas</span><span class="t-red">ATM</span>
                    </h1>
                    <div class="date-info">
                        <h2 id="currentMonthLabel">CARGANDO...</h2>
                        <span class="badge-week" id="currentWeekLabel">...</span>
                    </div>
                </div>
            </div>
            <div class="right-buttons">
                <button class="theme-toggle" id="pdfBtn" onclick="downloadPDF()"><i class="fas fa-file-pdf"></i></button>
                <button class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon" id="themeIcon"></i></button>
            </div>
        </div>
        
        <div class="nav-row">
            <div class="nav-arrows-group">
                <button class="nav-btn" onclick="changeDate(-1)"><i class="fas fa-chevron-left"></i></button>
                <button class="nav-btn" onclick="changeDate(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="view-switcher">
                <div id="btnWeek" class="switch-item active" onclick="switchView('week')">Semana</div>
                <div id="btnMonth" class="switch-item" onclick="switchView('month')">Mes</div>
            </div>
        </div>
        <div id="datesContainer" class="ios-date-strip"></div>
    </div>

    <main class="agenda-feed" id="pdf-content"></main>

    <div class="floating-nav">
        <button id="addBtn" onclick="openMatchModal()">+</button>
    </div>

    <div id="saveFeedback" class="save-feedback-overlay">
        <div class="feedback-content"><span class="feedback-icon">‚öΩ</span><p>Partido Guardado</p></div>
    </div>

    <div id="newMatchModal" class="ios-modal-overlay">
        <div class="ios-sheet">
            <div class="sheet-header">
                <div class="sheet-controls">
                    <button class="btn-text cancel" onclick="closeModal()">Cancelar</button>
                    <span class="sheet-title" id="modalTitle">Nuevo Partido</span>
                    <button class="btn-text save" onclick="saveMatch()">Guardar</button>
                </div>
            </div>
            <div class="sheet-body">
                <div class="form-section">
                    <label class="input-label">üõ°Ô∏è EQUIPO Y COMPETICI√ìN</label>
                    <div class="row-inputs">
                        <input type="text" id="inputTeam" placeholder="Ej: Cadete A" class="ios-input">
                        <select id="inputComp" class="ios-input">
                            <option value="LIGA">LIGA</option>
                            <option value="AMISTOSO">AMISTOSO</option>
                            <option value="TORNEO">TORNEO</option>
                            <option value="COPA">COPA</option>
                        </select>
                    </div>
                    <div class="row-inputs">
                        <select id="inputJornada" class="ios-input">
                            <option value="" disabled selected>N¬∫ Jornada</option>
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                            <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
                            <option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option>
                            <option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option>
                            <option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option>
                            <option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="30">30</option>
                            <option value="31">31</option><option value="32">32</option><option value="33">33</option><option value="34">34</option><option value="35">35</option>
                            <option value="36">36</option><option value="37">37</option><option value="38">38</option><option value="39">39</option><option value="40">40</option>
                        </select>
                        <input type="text" id="inputRival" placeholder="Rival" class="ios-input">
                    </div>
                </div>
                <div class="form-section">
                    <label class="input-label">üìÖ FECHA Y HORA ‚è∞</label>
                    <div class="row-inputs">
                        <input type="date" id="inputDate" class="ios-input">
                        <input type="time" id="inputTime" class="ios-input">
                    </div>
                </div>
                <div class="form-section">
                    <label class="input-label">üèüÔ∏è LUGAR Y √ÅRBITRO ‚öñÔ∏è</label>
                    <input type="text" id="inputPlace" placeholder="Campo de f√∫tbol" class="ios-input">
                    <select id="inputRef" class="ios-input">
                        <option value="NO">¬øSolicitar √Årbitro? NO</option>
                        <option value="SI">¬øSolicitar √Årbitro? SI</option>
                    </select>
                </div>
                <div class="form-section">
                    <label class="input-label">üìù OBSERVACIONES</label>
                    <textarea id="inputNotes" class="ios-input" rows="2" style="resize:none;" placeholder="Punto de encuentro..."></textarea>
                </div>
                <div style="height: 40px;"></div>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW OK'))
                .catch(err => console.log('SW Error', err));
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCPpDjMO5bHuSYvH8cVS5tUF_L7aSKHT8g",
            authDomain: "jornadas-atm-f41b7.firebaseapp.com",
            databaseURL: "https://jornadas-atm-f41b7-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "jornadas-atm-f41b7",
            storageBucket: "jornadas-atm-f41b7.firebasestorage.app",
            messagingSenderId: "933790154854",
            appId: "1:933790154854:web:0ec9b0ee6479c47ac6eda7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let matchesDB = {};

        window.currentDate = new Date();
        window.viewMode = 'week';
        window.currentEditingId = null;

        if (localStorage.getItem('atm_theme') === 'light') { 
            document.body.classList.add('light-mode'); 
            document.getElementById('themeIcon').className = 'fas fa-sun'; 
        }

        onValue(ref(db, 'matches'), (snapshot) => {
            matchesDB = snapshot.val() || {};
            window.renderAll();
        });

        window.downloadPDF = () => {
            const element = document.getElementById('pdf-content');
            if (element.innerText.includes('No hay partidos')) return alert('No hay partidos.');

            const btn = document.getElementById('pdfBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            const actionButtons = element.querySelectorAll('.card-actions');
            actionButtons.forEach(el => el.style.display = 'none');

            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = window.currentDate.toLocaleDateString('es-ES', options);

            const opt = {
                margin: 15,
                filename: `Jornadas_ATM_${window.currentDate.toISOString().split('T')[0]}.pdf`,
                image: { type: 'png' },
                html2canvas: { scale: 4, useCORS: true, backgroundColor: document.body.classList.contains('light-mode') ? '#f2f4f8' : '#0b0d17' },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                actionButtons.forEach(el => el.style.display = 'flex');
                btn.innerHTML = '<i class="fas fa-file-pdf"></i>';
            });
        };

        window.openMatchModal = () => {
            window.currentEditingId = null;
            document.getElementById('modalTitle').innerText = "Nuevo Partido";
            document.getElementById('inputTeam').value = "";
            document.getElementById('inputDate').value = window.currentDate.toISOString().split('T')[0];
            document.getElementById('newMatchModal').classList.add('open');
        };

        window.saveMatch = () => {
            const team = document.getElementById('inputTeam').value;
            const dateStr = document.getElementById('inputDate').value;
            if(!team || !dateStr) return alert("Faltan datos");

            const matchData = {
                team, date: dateStr,
                comp: document.getElementById('inputComp').value,
                jornada: document.getElementById('inputJornada').value,
                rival: document.getElementById('inputRival').value,
                time: document.getElementById('inputTime').value,
                place: document.getElementById('inputPlace').value,
                referee: document.getElementById('inputRef').value,
                notes: document.getElementById('inputNotes').value
            };

            const path = `matches/${dateStr}`;
            const promise = window.currentEditingId ? set(ref(db, `${path}/${window.currentEditingId}`), matchData) : push(ref(db, path), matchData);
            
            promise.then(() => {
                window.closeModal();
                const f = document.getElementById('saveFeedback');
                f.classList.add('show');
                setTimeout(() => f.classList.remove('show'), 1500);
            });
        };

        window.renderAll = () => {
            const months = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];
            document.getElementById('currentMonthLabel').innerText = `${months[window.currentDate.getMonth()]} ${window.currentDate.getFullYear()}`;
            
            const container = document.getElementById('datesContainer');
            container.innerHTML = '';
            let d = new Date(window.currentDate);
            let start = window.viewMode === 'week' ? new Date(d.setDate(d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1))) : new Date(window.currentDate.getFullYear(), window.currentDate.getMonth(), 1);
            let limit = window.viewMode === 'week' ? 7 : new Date(window.currentDate.getFullYear(), window.currentDate.getMonth() + 1, 0).getDate();

            for(let i=0; i<limit; i++) {
                let temp = new Date(start);
                window.viewMode === 'week' ? temp.setDate(start.getDate() + i) : temp.setDate(i + 1);
                let k = temp.toISOString().split('T')[0];
                let isSel = k === window.currentDate.toISOString().split('T')[0];
                let div = document.createElement('div');
                div.className = `date-item ${isSel ? 'active' : ''}`;
                div.onclick = () => { window.currentDate = temp; window.renderAll(); };
                div.innerHTML = `<span class="day-name">${['DOM','LUN','MAR','MI√â','JUE','VIE','S√ÅB'][temp.getDay()]}</span><span class="day-num">${temp.getDate()}</span>`;
                if(matchesDB[k]) div.innerHTML += `<div class="dot-indicator"></div>`;
                container.appendChild(div);
            }

            const feed = document.querySelector('.agenda-feed');
            const dayKey = window.currentDate.toISOString().split('T')[0];
            const data = matchesDB[dayKey] ? Object.entries(matchesDB[dayKey]) : [];
            data.sort((a, b) => a[1].time.localeCompare(b[1].time));

            feed.innerHTML = data.length ? '' : `<div class="empty-state centered"><h3>No hay partidos</h3></div>`;
            data.forEach(([id, item]) => {
                feed.innerHTML += `
                <div class="agenda-card">
                    <div class="modern-card">
                        <div class="card-header-row"><span class="badge">‚è∞ ${item.time}</span></div>
                        <h3 class="card-title">${item.team} vs ${item.rival}</h3>
                        <p class="card-subtitle">üèüÔ∏è ${item.place} | ‚öñÔ∏è ${item.referee}</p>
                        <div class="card-actions">
                            <button class="btn-ios-action secondary" onclick="editMatch('${dayKey}','${id}')"><i class="fas fa-pen"></i></button>
                            <button class="btn-ios-action secondary" onclick="deleteMatch('${dayKey}','${id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>`;
            });
        };

        window.changeDate = (dir) => {
            if(window.viewMode === 'week') window.currentDate.setDate(window.currentDate.getDate() + (dir*7));
            else window.currentDate.setMonth(window.currentDate.getMonth() + dir);
            window.renderAll();
        };

        window.switchView = (m) => {
            window.viewMode = m;
            document.getElementById('btnWeek').classList.toggle('active', m === 'week');
            document.getElementById('btnMonth').classList.toggle('active', m === 'month');
            window.renderAll();
        };

        window.closeModal = () => document.getElementById('newMatchModal').classList.remove('open');
        window.toggleTheme = () => {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('atm_theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        };

        window.renderAll();
    </script>
</body>
</html>